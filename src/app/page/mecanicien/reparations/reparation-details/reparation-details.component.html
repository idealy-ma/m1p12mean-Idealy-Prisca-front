<div class="reparation-details-container">
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Chargement des détails de la réparation...</p>
  </div>

  <div *ngIf="error" class="error">
    <p>{{ error }}</p>
  </div>

  <div *ngIf="!loading && !error && reparation" class="content">
    <!-- En-tête -->
    <div class="header">
      <div class="back-button" (click)="goBack()">
        <i class="fas fa-arrow-left"></i>
        Retour à la liste
      </div>
      <div class="title-section">
        <h1>Réparation #{{ reparation._id }}</h1>
        <div class="status-badge" [ngClass]="getStatusClass(reparation.status)">
          {{ getStatusLabel(reparation.status) }}
        </div>
      </div>
      <div class="actions">
        <button *ngIf="reparation.status !== 'termine' && reparation.status !== 'annule'"
                class="btn btn-primary"
                (click)="updateStatus('termine')">
          <i class="fas fa-check"></i> Terminer
        </button>
      </div>
    </div>

    <!-- Informations principales -->
    <div class="main-info">
      <div class="vehicle-info">
        <h2>Véhicule</h2>
        <div class="info-grid">
          <div class="info-item">
            <label>Marque/Modèle</label>
            <span>{{ reparation.vehicule.marque }} {{ reparation.vehicule.modele }}</span>
          </div>
          <div class="info-item">
            <label>Immatriculation</label>
            <span>{{ reparation.vehicule.immatricule }}</span>
          </div>
          <div class="info-item">
            <label>Année</label>
            <span>{{ reparation.vehicule.annee }}</span>
          </div>
          <div class="info-item">
            <label>Kilométrage</label>
            <span>{{ reparation.vehicule.kilometrage }} km</span>
          </div>
        </div>
      </div>

      <div class="client-info">
        <h2>Client</h2>
        <div class="info-grid">
          <div class="info-item">
            <label>Nom</label>
            <span>{{ reparation.client.nom }} {{ reparation.client.prenom }}</span>
          </div>
          <div class="info-item">
            <label>Email</label>
            <span>{{ reparation.client.email }}</span>
          </div>
          <div class="info-item">
            <label>Téléphone</label>
            <span>{{ reparation.client.telephone }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Description et progression -->
    <div class="description-section">
      <h2>Description</h2>
      <p>{{ reparation.description }}</p>
      
      <div class="progress-section">
        <div class="progress-header">
          <div class="progress-label">Progression globale</div>
          <div class="progress-percentage" [ngClass]="{'completed': reparation.progression === 100}">
            <span class="percentage-value">{{ reparation.progression }}%</span>
            <span class="percentage-icon" *ngIf="reparation.progression === 100"><i class="fas fa-check-circle"></i></span>
          </div>
        </div>
        
        <div class="progress-bar-container">
          <div class="progress-bar">
            <div class="progress" [style.width.%]="reparation.progression"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation des onglets -->
    <div class="tabs">
      <button [class.active]="activeTab === 'etapes'"
              (click)="activeTab = 'etapes'">
        <i class="fas fa-tasks"></i> Étapes
      </button>
      <button [class.active]="activeTab === 'photos'"
              (click)="activeTab = 'photos'">
        <i class="fas fa-camera"></i> Documentation visuelle
      </button>
    </div>

    <!-- Contenu des onglets -->
    <div class="tab-content">
      <!-- Onglet Étapes -->
      <div *ngIf="activeTab === 'etapes'" class="etapes-tab">
        <!-- Filtres d'étape -->
        <div class="etape-filters">
          <div class="filter-group">
            <label>Statut:</label>
            <div class="btn-group">
              <button type="button" class="btn" [class.btn-active]="filterStatus === 'tous'" (click)="updateStatusFilter('tous')">Tous</button>
              <button type="button" class="btn" [class.btn-active]="filterStatus === 'a_faire'" (click)="updateStatusFilter('a_faire')">À faire</button>
              <button type="button" class="btn" [class.btn-active]="filterStatus === 'en_cours'" (click)="updateStatusFilter('en_cours')">En cours</button>
              <button type="button" class="btn" [class.btn-active]="filterStatus === 'termine'" (click)="updateStatusFilter('termine')">Terminés</button>
            </div>
          </div>
        </div>

        <!-- Liste des étapes, inspirée de la todo-list -->
        <div class="todo-list">
          <div *ngFor="let etape of reparation.etapes" 
               class="todo-item" 
               [ngClass]="{
                 'todo-completed': etape.status === 'termine',
                 'todo-in-progress': etape.status === 'en_cours',
                 'todo-pending': etape.status === 'a_faire'
               }">
            
            <div class="todo-item-header">
              <div class="todo-checkbox">
                <input type="checkbox" [checked]="etape.status === 'termine'" (change)="updateEtapeStatus(etape._id, etape.status === 'termine' ? 'a_faire' : 'termine')">
              </div>
              
              <div class="todo-content">
                <div class="todo-name">
                  {{ etape.nom }}
                  <span class="photo-indicator" *ngIf="countPhotosForEtape(etape._id) > 0" (click)="activeTab = 'photos'; photoFilterEtapeId = etape._id; filterPhotosByEtape(etape._id)">
                    <i class="fas fa-camera"></i> {{ countPhotosForEtape(etape._id) }}
                  </span>
                </div>
                <div class="todo-details">
                  <span class="todo-type">
                    <i class="fas fa-tasks"></i> Étape
                  </span>
                  <span class="todo-status" [ngClass]="getStatusClass(etape.status)">
                    <i class="fas" 
                      [ngClass]="{
                        'fa-clock': etape.status === 'a_faire',
                        'fa-spinner fa-spin': etape.status === 'en_cours',
                        'fa-check-circle': etape.status === 'termine'
                      }"></i>
                    {{ getStatusLabel(etape.status) }}
                  </span>
                  
                  <span class="todo-timing" *ngIf="etape.dateDebut">
                    <i class="fas fa-calendar-alt"></i>
                    Début: {{ etape.dateDebut | date:'dd/MM/yyyy HH:mm' }}
                  </span>
                  
                  <span class="todo-timing" *ngIf="etape.dateFin">
                    <i class="fas fa-calendar-check"></i>
                    Fin: {{ etape.dateFin | date:'dd/MM/yyyy HH:mm' }}
                  </span>
                </div>
                
                <div class="todo-description">
                  <i class="fas fa-info-circle"></i> {{ etape.description }}
                </div>
              </div>
              
              <div class="todo-actions">
                <button *ngIf="etape.status === 'a_faire'"
                        class="btn-action btn-start"
                        (click)="updateEtapeStatus(etape._id, 'en_cours')">
                  <i class="fas fa-play"></i> Démarrer
                </button>
                <button *ngIf="etape.status === 'en_cours'"
                        class="btn-action btn-complete"
                        (click)="updateEtapeStatus(etape._id, 'termine')">
                  <i class="fas fa-check"></i> Terminer
                </button>
                <button *ngIf="etape.status === 'termine'"
                        class="btn-action btn-restart"
                        (click)="updateEtapeStatus(etape._id, 'en_cours')">
                  <i class="fas fa-redo"></i> Rouvrir
                </button>
              </div>
            </div>
            
            <!-- Bouton pour afficher/masquer les commentaires -->
            <div class="toggle-comments">
              <button class="btn-toggle" (click)="toggleCommentairesVisibilite(etape._id)">
                <i class="fas" [ngClass]="{'fa-chevron-down': commentairesVisibles[etape._id], 'fa-chevron-right': !commentairesVisibles[etape._id]}"></i>
                {{ commentairesVisibles[etape._id] ? 'Masquer les commentaires' : 'Afficher les commentaires' }}
                <span class="comment-count" *ngIf="etape.commentaires.length > 0">({{ etape.commentaires.length }})</span>
              </button>
            </div>
            
            <!-- Commentaires - conditionnés par l'état de visibilité -->
            <div class="todo-comments" *ngIf="commentairesVisibles[etape._id]">
              <h4>Commentaires</h4>
              <div class="commentaires-list">
                <div *ngFor="let commentaire of etape.commentaires" class="commentaire" [class.expanded]="commentaire.expanded">
                  <div class="commentaire-header">
                    <span class="auteur">{{ commentaire.auteur }}</span>
                    <span class="date">{{ commentaire.date | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                  <div class="text-container">
                    <p>{{ commentaire.texte }}</p>
                    <button *ngIf="commentaire.texte.length > 150" 
                            class="expand-btn" 
                            (click)="toggleCommentExpand(commentaire)">
                      {{ commentaire.expanded ? 'Voir moins' : 'Voir plus' }}
                    </button>
                  </div>
                </div>
              </div>
              <div class="nouveau-commentaire">
                <textarea [(ngModel)]="newComment"
                          placeholder="Ajouter un commentaire..."
                          (keyup.enter)="addComment(etape._id)"></textarea>
                <button class="btn-send" (click)="addComment(etape._id)">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
          
          <div *ngIf="reparation.etapes.length === 0" class="no-todos">
            Aucune étape n'a été définie pour cette réparation.
          </div>
        </div>
      </div>

      <!-- Onglet Photos -->
      <div *ngIf="activeTab === 'photos'" class="photos-tab">
        <h2>Documentation visuelle</h2>
        
        <!-- Filtres pour les photos -->
        <div class="photos-filters">
          <div class="filter-group">
            <label>Filtrer par étape:</label>
            <select [(ngModel)]="photoFilterEtapeId" (change)="filterPhotosByEtape(photoFilterEtapeId)">
              <option value="">Toutes les photos</option>
              <option *ngFor="let etape of reparation.etapes" [value]="etape._id">
                {{ etape.nom }} ({{ countPhotosForEtape(etape._id) }})
              </option>
            </select>
          </div>
        </div>
        
        <div class="upload-section">
          <h3>Ajouter une nouvelle photo</h3>
          
          <div class="upload-form">
            <div class="file-input-group">
              <label for="photo-file">Sélectionner une image</label>
              <input type="file" 
                     id="photo-file"
                     accept="image/*" 
                     (change)="handleFileChange($event)"
                     #fileInput>
              <span *ngIf="newPhoto" class="file-selected">
                {{ newPhoto.name }}
              </span>
            </div>
            
            <div class="photo-details">
              <div class="input-group">
                <label for="photo-type">Type de photo</label>
                <select id="photo-type" [(ngModel)]="photoType">
                  <option value="probleme">Problème identifié</option>
                  <option value="diagnostic">Diagnostic</option>
                  <option value="reparation">Réparation en cours</option>
                  <option value="resultat">Résultat final</option>
                </select>
              </div>
              
              <div class="input-group">
                <label for="photo-etape">Associer à une étape</label>
                <select id="photo-etape" [(ngModel)]="photoEtapeId">
                  <option value="">Aucune étape spécifique</option>
                  <option *ngFor="let etape of reparation.etapes" [value]="etape._id">
                    {{ etape.nom }}
                  </option>
                </select>
              </div>
              
              <div class="input-group">
                <label for="photo-description">Description détaillée</label>
                <textarea id="photo-description" 
                          [(ngModel)]="photoDescription"
                          placeholder="Décrivez ce que montre cette photo et le problème identifié..."></textarea>
              </div>
            </div>
            
            <button class="btn btn-primary upload-btn" 
                    (click)="uploadPhoto(); fileInput.value = ''"
                    [disabled]="!newPhoto || !photoDescription.trim()">
              <i class="fas fa-upload"></i> Ajouter la photo
            </button>
          </div>
        </div>

        <div class="photos-grid">
          <div *ngFor="let photo of filteredPhotos" class="photo-card" [attr.data-type]="photo.type">
            <div class="photo-type-badge">{{ photo.type === 'probleme' ? 'Problème' : 
                                            photo.type === 'diagnostic' ? 'Diagnostic' : 
                                            photo.type === 'reparation' ? 'Réparation' : 
                                            'Résultat' }}</div>
            <img [src]="photo.url" [alt]="photo.description">
            <div class="photo-info">
              <p>{{ photo.description }}</p>
              <span class="date">{{ photo.date | date:'dd/MM/yyyy HH:mm' }}</span>
              <span *ngIf="photo.etapeId" class="etape-associee">
                Étape: {{ getEtapeNomById(photo.etapeId) }}
              </span>
            </div>
          </div>
          
          <div *ngIf="filteredPhotos.length === 0" class="no-photos">
            <p *ngIf="!photoFilterEtapeId">Aucune photo n'a été ajoutée pour cette réparation.</p>
            <p *ngIf="photoFilterEtapeId">Aucune photo n'est associée à cette étape.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div> 